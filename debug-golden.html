<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Golden Tests – Behaviour Trip-Wire</title>
  <style>
    body { font-family: monospace; background: #1a1a1a; color: #e0e0e0; padding: 2rem; }
    h1 { color: #fff; }
    .instructions { color: #888; margin-bottom: 2rem; }
  </style>
</head>
<body>
  <h1>Golden Tests – Behaviour Trip-Wire</h1>
  <p class="instructions">Open the browser console (Cmd+Option+J / Ctrl+Shift+J) to see output.</p>

  <script type="module">
    import { generateRamp } from './assets/js/colorModels/index.js';
    import {
      hexToOklch,
      hexToSrgb, srgbToLinearRgb, linearRgbToOklab
    } from './assets/js/colorModels/convert.js';

    // ── Helpers ──────────────────────────────────────────────

    /** Convert hex to OKLab {L, a, b} */
    function hexToOklab(hex) {
      return linearRgbToOklab(srgbToLinearRgb(hexToSrgb(hex)));
    }

    /** ΔE in OKLab (simple Euclidean) */
    function deltaE(hex1, hex2) {
      const a = hexToOklab(hex1);
      const b = hexToOklab(hex2);
      return Math.sqrt((a.L - b.L) ** 2 + (a.a - b.a) ** 2 + (a.b - b.b) ** 2);
    }

    // ── Golden cases ─────────────────────────────────────────
    // Blue, red, pink-red, yellow, neutral, teal — all at steps=11.

    const goldenCases = [
      // Blue
      { base: '#2F6FED', temp: +1, steps: 11, mode: 'conservative' },
      { base: '#2F6FED', temp: -1, steps: 11, mode: 'conservative' },
      { base: '#2F6FED', temp: +1, steps: 11, mode: 'painterly' },
      { base: '#2F6FED', temp: -1, steps: 11, mode: 'painterly' },
      // Red
      { base: '#B51A00', temp: +1, steps: 11, mode: 'painterly' },
      { base: '#B51A00', temp: -1, steps: 11, mode: 'painterly' },
      // Pink-red
      { base: '#E63B7A', temp: -1, steps: 11, mode: 'painterly' },
      // Yellow
      { base: '#FEC700', temp: +1, steps: 11, mode: 'conservative' },
      { base: '#FEC700', temp: -1, steps: 11, mode: 'conservative' },
      { base: '#FEC700', temp: -1, steps: 11, mode: 'painterly' },
      // Neutral
      { base: '#e9e9e9', temp: +1, steps: 11, mode: 'conservative' },
      { base: '#e9e9e9', temp: -1, steps: 11, mode: 'conservative' },
      { base: '#e9e9e9', temp: +1, steps: 11, mode: 'painterly' },
      { base: '#e9e9e9', temp: -1, steps: 11, mode: 'painterly' },
      // Teal
      { base: '#47868B', temp: +1, steps: 11, mode: 'conservative' },
      { base: '#47868B', temp: -1, steps: 11, mode: 'conservative' },
      { base: '#47868B', temp: +1, steps: 11, mode: 'painterly' },
      { base: '#47868B', temp: -1, steps: 11, mode: 'painterly' },
    ];

    // ── Run ──────────────────────────────────────────────────

    function runGoldenTests() {
      console.clear();

      let hardFails = 0;
      const warnings = [];   // { base, message }

      // Pre-generate all ramps once
      const ramps = goldenCases.map(tc => ({
        ...tc,
        ramp: generateRamp(tc.base, tc.temp, tc.steps, tc.mode),
      }));

      // Helper to label a case
      const label = tc => `${tc.base} temp=${tc.temp > 0 ? '+1' : '-1'} ${tc.mode}`;

      // ── Tier 1: Hard FAILs ──────────────────────────────

      console.log('='.repeat(60));
      console.log('TIER 1 — HARD CHECKS');
      console.log('='.repeat(60));

      // 1a. Monotonic lightness (strict increase)
      console.log('');
      console.log('1a. Monotonic lightness');
      for (const tc of ramps) {
        let prev = -Infinity;
        for (let i = 0; i < tc.ramp.length; i++) {
          const L = hexToOklch(tc.ramp[i]).L;
          if (L <= prev) {
            hardFails++;
            console.log(`  FAIL  ${label(tc)} — step ${i} L=${L.toFixed(4)} <= prev ${prev.toFixed(4)}`);
          }
          prev = L;
        }
      }
      if (hardFails === 0) console.log('  all pass');

      // 1b. Midpoint anchoring (mid step must equal base hex)
      console.log('');
      console.log('1b. Midpoint anchoring');
      const midFailsBefore = hardFails;
      for (const tc of ramps) {
        const mid = Math.floor(tc.steps / 2);
        const midHex = tc.ramp[mid].toUpperCase();
        const baseHex = tc.base.toUpperCase();
        if (midHex !== baseHex) {
          hardFails++;
          console.log(`  FAIL  ${label(tc)} — base=${baseHex}  mid[${mid}]=${midHex}`);
        }
      }
      if (hardFails === midFailsBefore) console.log('  all pass');

      // ── Tier 2: Soft WARNs ──────────────────────────────

      console.log('');
      console.log('='.repeat(60));
      console.log('TIER 2 — SOFT WARNINGS');
      console.log('='.repeat(60));

      // Collect unique bases that have visible chroma (C >= 0.02 at midpoint).
      const chromaBases = [...new Set(goldenCases.map(tc => tc.base))].filter(base => {
        const oklch = hexToOklch(base);
        return oklch.C >= 0.02;
      });

      // "Top 3 highlights" = last 3 steps.
      const top3 = (steps) => [steps - 3, steps - 2, steps - 1];

      // Threshold: at least one of the top-3 highlight pairs must differ
      // by ΔE_oklab >= 1.0, ignoring pairs where both have C < 0.01.
      const DE_THRESHOLD = 1.0;
      const LOW_C = 0.01;

      // 2a. Low temperature sensitivity (warm vs cool, same mode)
      console.log('');
      console.log('2a. Temperature sensitivity (warm vs cool, same mode)');

      for (const base of chromaBases) {
        const modes = [...new Set(goldenCases.filter(tc => tc.base === base).map(tc => tc.mode))];
        for (const mode of modes) {
          const warm = ramps.find(tc => tc.base === base && tc.mode === mode && tc.temp > 0);
          const cool = ramps.find(tc => tc.base === base && tc.mode === mode && tc.temp < 0);
          if (!warm || !cool) continue;

          const indices = top3(warm.steps);
          let maxDE = 0;
          let comparedAny = false;
          for (const i of indices) {
            const cW = hexToOklch(warm.ramp[i]).C;
            const cC = hexToOklch(cool.ramp[i]).C;
            // Skip if both near-zero chroma (hue meaningless)
            if (cW < LOW_C && cC < LOW_C) continue;
            comparedAny = true;
            const de = deltaE(warm.ramp[i], cool.ramp[i]);
            if (de > maxDE) maxDE = de;
          }

          if (comparedAny && maxDE < DE_THRESHOLD) {
            const msg = `${mode}: max ΔE=${maxDE.toFixed(3)} across top-3 highlights (threshold ${DE_THRESHOLD})`;
            warnings.push({ base, message: msg });
            console.log(`  WARN  ${base} ${mode} — ${msg}`);
          }
        }
      }

      // 2b. Low mode separation (conservative vs painterly, same temp)
      console.log('');
      console.log('2b. Mode separation (conservative vs painterly, same temp)');

      for (const base of chromaBases) {
        const temps = [...new Set(goldenCases.filter(tc => tc.base === base).map(tc => tc.temp))];
        for (const temp of temps) {
          const cons = ramps.find(tc => tc.base === base && tc.temp === temp && tc.mode === 'conservative');
          const paint = ramps.find(tc => tc.base === base && tc.temp === temp && tc.mode === 'painterly');
          if (!cons || !paint) continue;

          const indices = top3(cons.steps);
          let maxDE = 0;
          let comparedAny = false;
          for (const i of indices) {
            const cCons = hexToOklch(cons.ramp[i]).C;
            const cPaint = hexToOklch(paint.ramp[i]).C;
            if (cCons < LOW_C && cPaint < LOW_C) continue;
            comparedAny = true;
            const de = deltaE(cons.ramp[i], paint.ramp[i]);
            if (de > maxDE) maxDE = de;
          }

          if (comparedAny && maxDE < DE_THRESHOLD) {
            const tempLabel = temp > 0 ? 'warm' : 'cool';
            const msg = `${tempLabel}: max ΔE=${maxDE.toFixed(3)} across top-3 highlights (threshold ${DE_THRESHOLD})`;
            warnings.push({ base, message: msg });
            console.log(`  WARN  ${base} ${tempLabel} — ${msg}`);
          }
        }
      }

      // ── Summary ─────────────────────────────────────────

      console.log('');
      console.log('='.repeat(60));
      console.log('SUMMARY');
      console.log('='.repeat(60));
      console.log(`  Cases:    ${ramps.length}`);
      console.log(`  FAIL:     ${hardFails}`);
      console.log(`  WARN:     ${warnings.length}`);

      if (warnings.length > 0) {
        console.log('');
        console.log('  Warnings by base:');
        const grouped = {};
        for (const w of warnings) {
          (grouped[w.base] ??= []).push(w.message);
        }
        for (const [base, msgs] of Object.entries(grouped)) {
          console.log(`    ${base}`);
          for (const m of msgs) console.log(`      – ${m}`);
        }
      }

      console.log('');
      if (hardFails > 0) {
        console.log(`❌  ${hardFails} hard fail(s) — see above.`);
      } else {
        console.log('✅  All hard checks pass.');
      }
      console.log('='.repeat(60));
    }

    window.runGoldenTests = runGoldenTests;
    runGoldenTests();
  </script>
</body>
</html>
